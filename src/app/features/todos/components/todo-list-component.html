<!-- Dashboard des statistiques -->
<div class="mx-20 mt-8">
  <div class="mb-8">
    <h2 class="text-2xl font-bold text-gray-900 mb-4">Statistiques en temps réel</h2>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-sm font-medium text-gray-500">Total</h3>
        <p class="text-2xl font-bold text-gray-900">{{ todoService.todoStats().total }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-sm font-medium text-gray-500">Complétés</h3>
        <p class="text-2xl font-bold text-green-600">{{ todoService.todoStats().completed }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-sm font-medium text-gray-500">En cours</h3>
        <p class="text-2xl font-bold text-blue-600">{{ todoService.todoStats().inProgress }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-sm font-medium text-gray-500">Priorité haute</h3>
        <p class="text-2xl font-bold text-red-600">{{ todoService.todoStats().highPriority }}</p>
      </div>
      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="text-sm font-medium text-gray-500">Taux de complétion</h3>
        <p class="text-2xl font-bold text-purple-600">
          {{ todoService.todoStats().completionRate | number: '1.0-0' }}%
        </p>
      </div>
    </div>
  </div>

  <!-- Formulaire d'ajout -->
  <div class="bg-white p-6 rounded-lg shadow-md mb-6">
    <h3 class="text-xl font-semibold mb-4">Ajouter une tâche</h3>
    <form (ngSubmit)="addTodo()" #todoForm="ngForm">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <input
          type="text"
          [(ngModel)]="newTodo.title"
          name="title"
          placeholder="Titre de la tâche"
          class="border p-2 rounded"
          required
        />

        <input
          type="text"
          [(ngModel)]="newTodo.description"
          name="description"
          placeholder="Description (optionnel)"
          class="border p-2 rounded"
        />
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <select [(ngModel)]="newTodo.priority" name="priority" class="border p-2 rounded">
          <option value="low">Basse priorité</option>
          <option value="medium">Priorité moyenne</option>
          <option value="high">Haute priorité</option>
        </select>

        <button
          type="submit"
          [disabled]="!todoForm.form.valid || addingTodo()"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
        >
          <ng-container *ngIf="addingTodo(); else addButton">
            <span
              class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"
            ></span>
            Ajout en cours...
          </ng-container>
          <ng-template #addButton> Ajouter </ng-template>
        </button>
      </div>
    </form>
  </div>

  <!-- Colonnes Kanban -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- À faire -->
    <div class="bg-gray-50 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        À faire
        <span class="text-sm text-gray-500">({{ todoService.pendingTodos().length }})</span>
      </h3>
      <div class="space-y-3">
        @for (todo of todoService.pendingTodos(); track trackByTodoId(todo.id)) {
          <div
            class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-gray-400"
            [appHighlight]="todo.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium text-gray-900">{{ todo.title }}</h4>
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full"
                [class.bg-red-100]="todo.priority === 'high'"
                [class.text-red-800]="todo.priority === 'high'"
                [class.bg-yellow-100]="todo.priority === 'medium'"
                [class.text-yellow-800]="todo.priority === 'medium'"
                [class.bg-green-100]="todo.priority === 'low'"
                [class.text-green-800]="todo.priority === 'low'"
              >
                {{ todo.priority | priority }}
              </span>
            </div>
            @if (todo.description) {
              <p class="text-sm text-gray-600 mb-3">{{ todo.description }}</p>
            }
            <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
              <span>Créé le {{ todo.createdAt | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="flex justify-end">
              <button
                (click)="startTodo(todo.id)"
                [disabled]="updatingTodo() === todo.id"
                class="bg-blue-600 text-white px-3 py-1 text-xs rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <ng-container *ngIf="updatingTodo() === todo.id; else startBtn">
                  <span
                    class="inline-block animate-spin rounded-full h-3 w-3 border-b-2 border-white"
                  ></span>
                </ng-container>
                <ng-template #startBtn> Commencer </ng-template>
              </button>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- En cours -->
    <div class="bg-gray-50 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        En cours
        <span class="text-sm text-gray-500">({{ todoService.inProgressTodos().length }})</span>
      </h3>
      <div class="space-y-3">
        @for (todo of todoService.inProgressTodos(); track trackByTodoId(todo.id)) {
          <div
            class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400"
            [appHighlight]="todo.priority === 'high' ? 'rgba(239, 68, 68, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium text-gray-900">{{ todo.title }}</h4>
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full"
                [class.bg-red-100]="todo.priority === 'high'"
                [class.text-red-800]="todo.priority === 'high'"
                [class.bg-yellow-100]="todo.priority === 'medium'"
                [class.text-yellow-800]="todo.priority === 'medium'"
                [class.bg-green-100]="todo.priority === 'low'"
                [class.text-green-800]="todo.priority === 'low'"
              >
                {{ todo.priority | priority }}
              </span>
            </div>
            @if (todo.description) {
              <p class="text-sm text-gray-600 mb-3">{{ todo.description }}</p>
            }
            <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
              <span>Mis à jour le {{ todo.updatedAt | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="flex justify-end">
              <button
                (click)="completeTodo(todo.id)"
                [disabled]="updatingTodo() === todo.id"
                class="bg-green-600 text-white px-3 py-1 text-xs rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <ng-container *ngIf="updatingTodo() === todo.id; else completeBtn">
                  <span
                    class="inline-block animate-spin rounded-full h-3 w-3 border-b-2 border-white"
                  ></span>
                </ng-container>
                <ng-template #completeBtn> Terminer </ng-template>
              </button>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Terminé -->
    <div class="bg-gray-50 rounded-lg p-4">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Terminé
        <span class="text-sm text-gray-500">({{ todoService.completedTodos().length }})</span>
      </h3>
      <div class="space-y-3">
        @for (todo of todoService.completedTodos(); track trackByTodoId(todo.id)) {
          <div
            class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-400"
            [appHighlight]="todo.priority === 'high' ? 'rgba(34, 197, 94, 0.1)' : 'transparent'"
            [appHighlightDelay]="todo.priority === 'high' ? 500 : 0"
          >
            <div class="flex justify-between items-start mb-2">
              <h4 class="font-medium text-gray-900 line-through">{{ todo.title }}</h4>
              <span
                class="px-2 py-1 text-xs font-semibold rounded-full"
                [class.bg-red-100]="todo.priority === 'high'"
                [class.text-red-800]="todo.priority === 'high'"
                [class.bg-yellow-100]="todo.priority === 'medium'"
                [class.text-yellow-800]="todo.priority === 'medium'"
                [class.bg-green-100]="todo.priority === 'low'"
                [class.text-green-800]="todo.priority === 'low'"
              >
                {{ todo.priority | priority }}
              </span>
            </div>
            @if (todo.description) {
              <p class="text-sm text-gray-600 mb-3 line-through">{{ todo.description }}</p>
            }
            <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
              <span>Terminé le {{ todo.updatedAt | date: 'dd/MM/yyyy' }}</span>
            </div>
            <div class="flex justify-end">
              <button
                (click)="reopenTodo(todo.id)"
                [disabled]="updatingTodo() === todo.id"
                class="bg-orange-600 text-white px-3 py-1 text-xs rounded hover:bg-orange-700 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <ng-container *ngIf="updatingTodo() === todo.id; else reopenBtn">
                  <span
                    class="inline-block animate-spin rounded-full h-3 w-3 border-b-2 border-white"
                  ></span>
                </ng-container>
                <ng-template #reopenBtn> Rouvrir </ng-template>
              </button>
            </div>
          </div>
        }
      </div>
    </div>
  </div>
</div>
